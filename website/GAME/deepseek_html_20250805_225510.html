<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>战机空战游戏 - 增强版</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(to bottom, #0a0a2a, #1a1a4a);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            color: white;
        }
        
        .game-container {
            position: relative;
            width: 900px;
            height: 650px;
            box-shadow: 0 0 30px rgba(0, 100, 255, 0.7);
            border-radius: 10px;
            overflow: hidden;
        }
        
        canvas {
            display: block;
        }
        
        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
        }
        
        .hud {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-between;
            z-index: 10;
        }
        
        .hud-panel {
            background: rgba(0, 20, 40, 0.8);
            border: 2px solid rgba(100, 180, 255, 0.5);
            border-radius: 10px;
            padding: 15px;
            backdrop-filter: blur(5px);
            box-shadow: 0 0 15px rgba(0, 100, 255, 0.3);
        }
        
        .stats {
            display: flex;
            gap: 30px;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: #4df0ff;
            text-shadow: 0 0 10px rgba(77, 240, 255, 0.7);
        }
        
        .stat-label {
            font-size: 14px;
            color: #a0d0ff;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 5px;
        }
        
        .radar {
            width: 200px;
            height: 200px;
            background: rgba(0, 10, 30, 0.7);
            border: 2px solid #00a8ff;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
        }
        
        .radar::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: repeating-conic-gradient(
                transparent 0deg 5deg,
                rgba(0, 168, 255, 0.1) 5deg 10deg
            );
            border-radius: 50%;
        }
        
        .radar-sweep {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 255, 179, 0.2));
            clip-path: polygon(50% 50%, 100% 50%, 50% 50%);
            animation: radarSweep 4s linear infinite;
        }
        
        @keyframes radarSweep {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        
        .radar-center {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 8px;
            height: 8px;
            background: #ff3e3e;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 10px #ff3e3e;
        }
        
        .radar-dot {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #ff9a3e;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 8px #ff9a3e;
        }
        
        .weapon-info {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 20, 40, 0.8);
            border: 2px solid rgba(100, 180, 255, 0.5);
            border-radius: 10px;
            padding: 15px;
            backdrop-filter: blur(5px);
            display: flex;
            flex-direction: column;
            width: 250px;
        }
        
        .weapon-name {
            font-size: 18px;
            color: #4df0ff;
            margin-bottom: 5px;
        }
        
        .weapon-level {
            font-size: 14px;
            color: #ff9a3e;
            margin-bottom: 10px;
        }
        
        .weapon-ammo {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .ammo-dot {
            width: 12px;
            height: 12px;
            background: #ff9a3e;
            border-radius: 50%;
        }
        
        .crosshair {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 40px;
            height: 40px;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 5;
        }
        
        .crosshair::before, .crosshair::after {
            content: '';
            position: absolute;
            background: rgba(255, 50, 50, 0.8);
        }
        
        .crosshair::before {
            top: 50%;
            left: 0;
            width: 100%;
            height: 2px;
            transform: translateY(-50%);
        }
        
        .crosshair::after {
            left: 50%;
            top: 0;
            height: 100%;
            width: 2px;
            transform: translateX(-50%);
        }
        
        .screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0, 10, 30, 0.9);
            z-index: 20;
            backdrop-filter: blur(5px);
        }
        
        .title {
            font-size: 60px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #4df0ff;
            text-shadow: 0 0 20px rgba(77, 240, 255, 0.7);
            letter-spacing: 2px;
        }
        
        .subtitle {
            font-size: 24px;
            margin-bottom: 40px;
            color: #ff9a3e;
            max-width: 600px;
            text-align: center;
            line-height: 1.6;
        }
        
        .btn {
            background: linear-gradient(to right, #00c9ff, #00a8ff);
            color: white;
            border: none;
            padding: 15px 50px;
            font-size: 20px;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
            box-shadow: 0 5px 20px rgba(0, 168, 255, 0.4);
            font-weight: bold;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0, 168, 255, 0.6);
        }
        
        .btn-restart {
            background: linear-gradient(to right, #ff9a3e, #ff7a3e);
            margin: 10px 5px;
            padding: 12px 30px;
            font-size: 18px;
        }
        
        .instructions {
            margin-top: 40px;
            background: rgba(0, 30, 60, 0.6);
            padding: 25px;
            border-radius: 15px;
            max-width: 600px;
            font-size: 18px;
            line-height: 1.6;
            border: 2px solid rgba(100, 180, 255, 0.3);
        }
        
        .instructions h3 {
            color: #00a8ff;
            margin-bottom: 15px;
            font-size: 22px;
            text-align: center;
        }
        
        .instructions ul {
            text-align: left;
            padding-left: 30px;
        }
        
        .instructions li {
            margin-bottom: 10px;
        }
        
        .highlight {
            color: #ff9a3e;
            font-weight: bold;
        }
        
        .game-over {
            color: #ff3e3e;
            font-size: 80px;
            text-shadow: 0 0 20px rgba(255, 62, 62, 0.7);
            margin-bottom: 30px;
        }
        
        .final-stats {
            font-size: 28px;
            margin: 15px 0;
            background: rgba(0, 20, 40, 0.7);
            padding: 10px 20px;
            border-radius: 10px;
            min-width: 300px;
            text-align: center;
        }
        
        .final-stats span {
            color: #4df0ff;
            font-weight: bold;
        }
        
        .hidden {
            display: none;
        }
        
        .damage-indicator {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 0, 0, 0.3);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 15;
        }
        
        .powerup-indicator {
            position: absolute;
            top: 70px;
            right: 20px;
            background: rgba(0, 20, 40, 0.8);
            border: 2px solid rgba(100, 255, 100, 0.5);
            border-radius: 10px;
            padding: 10px 15px;
            backdrop-filter: blur(5px);
            box-shadow: 0 0 10px rgba(100, 255, 100, 0.3);
            color: #2ecc71;
            font-size: 16px;
            z-index: 10;
            display: none;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .powerup-slot {
            position: absolute;
            bottom: 100px;
            right: 20px;
            background: rgba(0, 20, 40, 0.8);
            border: 2px solid rgba(100, 180, 255, 0.5);
            border-radius: 10px;
            padding: 10px;
            backdrop-filter: blur(5px);
            display: flex;
            gap: 10px;
            z-index: 10;
        }
        
        .powerup-item {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            background: rgba(50, 50, 100, 0.6);
        }
        
        .powerup-item.active {
            background: rgba(100, 255, 100, 0.3);
            box-shadow: 0 0 10px rgba(100, 255, 100, 0.5);
            animation: glow 1.5s infinite alternate;
        }
        
        @keyframes glow {
            from { box-shadow: 0 0 5px rgba(100, 255, 100, 0.5); }
            to { box-shadow: 0 0 20px rgba(100, 255, 100, 0.8); }
        }
        
        .shield-powerup {
            color: #3498db;
        }
        
        .triple-shot {
            color: #f1c40f;
        }
        
        .controls-info {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 20, 40, 0.7);
            border: 1px solid rgba(100, 180, 255, 0.5);
            border-radius: 8px;
            padding: 10px 15px;
            font-size: 14px;
            color: #a0d0ff;
            z-index: 10;
        }
        
        .medal {
            font-size: 80px;
            margin: 20px 0;
            text-shadow: 0 0 15px rgba(255, 215, 0, 0.8);
        }
        
        .performance-chart {
            display: flex;
            gap: 15px;
            margin: 20px 0;
        }
        
        .chart-item {
            background: rgba(0, 30, 60, 0.7);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            min-width: 120px;
        }
        
        .chart-value {
            font-size: 24px;
            color: #4df0ff;
            margin-bottom: 5px;
        }
        
        .chart-label {
            font-size: 16px;
            color: #a0d0ff;
        }
        
        .map-selector {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        
        .map-option {
            width: 150px;
            height: 100px;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s;
            position: relative;
        }
        
        .map-option:hover {
            transform: scale(1.05);
            border-color: #00a8ff;
        }
        
        .map-option.selected {
            border-color: #ff9a3e;
            box-shadow: 0 0 20px rgba(255, 154, 62, 0.6);
        }
        
        .map-preview {
            width: 100%;
            height: 100%;
            background-size: cover;
        }
        
        .map-name {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            text-align: center;
            padding: 5px;
            font-size: 14px;
        }
        
        .boss-health {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 400px;
            height: 30px;
            background: rgba(0, 0, 0, 0.6);
            border: 2px solid #ff3e3e;
            border-radius: 15px;
            z-index: 10;
            overflow: hidden;
        }
        
        .boss-health-bar {
            height: 100%;
            width: 100%;
            background: linear-gradient(to right, #ff3e3e, #ff7a7a);
            transition: width 0.3s;
        }
        
        .boss-health-text {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 3px black;
        }
        
        .weapon-selector {
            display: flex;
            gap: 15px;
            margin: 20px 0;
        }
        
        .weapon-choice {
            width: 80px;
            height: 80px;
            background: rgba(0, 30, 60, 0.7);
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.3s;
        }
        
        .weapon-choice:hover {
            transform: scale(1.05);
            border-color: #00a8ff;
        }
        
        .weapon-choice.selected {
            border-color: #ff9a3e;
            box-shadow: 0 0 10px rgba(255, 154, 62, 0.6);
        }
        
        .weapon-icon {
            font-size: 30px;
            margin-bottom: 5px;
        }
        
        .weapon-choice-name {
            font-size: 14px;
            text-align: center;
        }
        
        .notification {
            position: absolute;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 20, 40, 0.9);
            border: 2px solid #00a8ff;
            border-radius: 10px;
            padding: 15px 30px;
            backdrop-filter: blur(5px);
            z-index: 25;
            font-size: 24px;
            color: #4df0ff;
            text-align: center;
            animation: slideIn 0.5s forwards, fadeOut 0.5s 2.5s forwards;
            display: none;
        }
        
        @keyframes slideIn {
            from { top: -100px; opacity: 0; }
            to { top: 100px; opacity: 1; }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        .level-indicator {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 50px;
            font-weight: bold;
            color: #ff9a3e;
            text-shadow: 0 0 20px rgba(255, 154, 62, 0.8);
            z-index: 25;
            animation: zoomInOut 1.5s forwards;
            display: none;
        }
        
        @keyframes zoomInOut {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }
        
        .restart-container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        
        .restart-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 20, 40, 0.8);
            border: 2px solid rgba(255, 100, 100, 0.7);
            border-radius: 10px;
            padding: 10px 15px;
            color: #ff7a7a;
            font-weight: bold;
            cursor: pointer;
            z-index: 25;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }
        
        .restart-button:hover {
            background: rgba(255, 100, 100, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 0 10px rgba(255, 100, 100, 0.5);
        }
        
        .pause-menu {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 20, 40, 0.9);
            border: 2px solid rgba(100, 180, 255, 0.5);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            z-index: 30;
            display: none;
            backdrop-filter: blur(10px);
            box-shadow: 0 0 30px rgba(0, 100, 255, 0.5);
        }
        
        .pause-menu h2 {
            color: #4df0ff;
            font-size: 40px;
            margin-bottom: 30px;
            text-shadow: 0 0 10px rgba(77, 240, 255, 0.7);
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <canvas id="gameCanvas" width="900" height="650"></canvas>
        <div class="damage-indicator" id="damageIndicator"></div>
        
        <div class="hud">
            <div class="hud-panel">
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-value" id="score">0</div>
                        <div class="stat-label">得分</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="health">100%</div>
                        <div class="stat-label">机体状态</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="level">1</div>
                        <div class="stat-label">作战区域</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="kills">0</div>
                        <div class="stat-label">击坠敌机</div>
                    </div>
                </div>
            </div>
            
            <div class="hud-panel">
                <div class="radar">
                    <div class="radar-sweep"></div>
                    <div class="radar-center"></div>
                    <!-- 雷达点会由JS动态添加 -->
                </div>
            </div>
        </div>
        
        <div class="restart-button" id="topRestartButton">
            <span>↺</span> 重新开始
        </div>
        
        <div class="weapon-info">
            <div class="weapon-name" id="weaponName">AIM-120 AMRAAM</div>
            <div class="weapon-level" id="weaponLevel">Lv.1</div>
            <div class="weapon-ammo" id="weaponAmmo">
                <!-- 弹药点由JS动态生成 -->
            </div>
        </div>
        
        <div class="powerup-slot">
            <div class="powerup-item shield-powerup" id="shieldSlot">🛡️</div>
            <div class="powerup-item triple-shot" id="tripleShotSlot">🔺</div>
        </div>
        
        <div class="powerup-indicator" id="powerupIndicator"></div>
        
        <div class="boss-health hidden" id="bossHealth">
            <div class="boss-health-bar" id="bossHealthBar"></div>
            <div class="boss-health-text">BOSS: <span id="bossHealthText">100%</span></div>
        </div>
        
        <div class="controls-info">
            ←→↑↓ 移动 | 空格 射击 | P 暂停 | R 重玩 | 1-3 切换武器
        </div>
        
        <div class="crosshair"></div>
        
        <div class="notification" id="notification"></div>
        <div class="level-indicator" id="levelIndicator"></div>
        
        <!-- 暂停菜单 -->
        <div class="pause-menu" id="pauseMenu">
            <h2>游戏暂停</h2>
            <div class="button-group">
                <button class="btn btn-restart" id="pauseRestartButton">重新开始</button>
                <button class="btn" id="resumeButton">继续游戏</button>
            </div>
            <button class="btn btn-restart" id="menuButton">返回主菜单</button>
        </div>
        
        <!-- 开始游戏界面 -->
        <div class="screen" id="startScreen">
            <h1 class="title">战机空战模拟 - 增强版</h1>
            <p class="subtitle">驾驶F-22猛禽战斗机，在多个战场执行空中优势任务</p>
            
            <div class="map-selector">
                <div class="map-option selected" data-map="space">
                    <div class="map-preview" style="background: linear-gradient(to bottom, #0f2027, #203a43, #2c5364);"></div>
                    <div class="map-name">太空战场</div>
                </div>
                <div class="map-option" data-map="city">
                    <div class="map-preview" style="background: linear-gradient(to bottom, #2c3e50, #4a6491);"></div>
                    <div class="map-name">城市上空</div>
                </div>
                <div class="map-option" data-map="desert">
                    <div class="map-preview" style="background: linear-gradient(to bottom, #61443a, #b98b73);"></div>
                    <div class="map-name">沙漠风暴</div>
                </div>
                <div class="map-option" data-map="ocean">
                    <div class="map-preview" style="background: linear-gradient(to bottom, #1a2980, #26d0ce);"></div>
                    <div class="map-name">海洋区域</div>
                </div>
            </div>
            
            <button class="btn" id="startButton">开始任务</button>
            
            <div class="instructions">
                <h3>作战指令</h3>
                <ul>
                    <li>使用 <span class="highlight">方向键</span> 或 <span class="highlight">WASD</span> 控制战机</li>
                    <li>按 <span class="highlight">空格键</span> 发射导弹</li>
                    <li>按 <span class="highlight">1-3</span> 键切换武器系统</li>
                    <li>按 <span class="highlight">P</span> 键暂停任务</li>
                    <li>按 <span class="highlight">R</span> 键重新开始游戏</li>
                    <li>收集 <span class="highlight">护盾🛡️</span> 和 <span class="highlight">三连发🔺</span>装备增强战力</li>
                    <li>每5关将遭遇强大的<span class="highlight">Boss战机</span></li>
                    <li>击败敌机获取积分升级武器系统</li>
                    <li>避开敌机，保护领空安全</li>
                </ul>
            </div>
        </div>
        
        <!-- 游戏结束界面 -->
        <div class="screen hidden" id="gameOverScreen">
            <h1 class="game-over">任务结束</h1>
            
            <div class="medal" id="medalDisplay">🥉</div>
            
            <div class="performance-chart">
                <div class="chart-item">
                    <div class="chart-value" id="finalScore">0</div>
                    <div class="chart-label">最终得分</div>
                </div>
                <div class="chart-item">
                    <div class="chart-value" id="finalKills">0</div>
                    <div class="chart-label">击坠敌机</div>
                </div>
                <div class="chart-item">
                    <div class="chart-value" id="finalLevel">1</div>
                    <div class="chart-label">作战区域</div>
                </div>
            </div>
            
            <p class="final-stats">任务时长: <span id="missionTime">00:00</span></p>
            <p class="final-stats">命中率: <span id="accuracy">0%</span></p>
            <p class="final-stats">Boss击破: <span id="bossKills">0</span></p>
            
            <div class="restart-container">
                <button class="btn btn-restart" id="restartButton">重新开始</button>
                <button class="btn btn-restart" id="menuButton2">返回主菜单</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 获取游戏元素
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            const startScreen = document.getElementById('startScreen');
            const gameOverScreen = document.getElementById('gameOverScreen');
            const startButton = document.getElementById('startButton');
            const restartButton = document.getElementById('restartButton');
            const topRestartButton = document.getElementById('topRestartButton');
            const pauseRestartButton = document.getElementById('pauseRestartButton');
            const menuButton = document.getElementById('menuButton');
            const menuButton2 = document.getElementById('menuButton2');
            const resumeButton = document.getElementById('resumeButton');
            const pauseMenu = document.getElementById('pauseMenu');
            const scoreDisplay = document.getElementById('score');
            const healthDisplay = document.getElementById('health');
            const levelDisplay = document.getElementById('level');
            const killsDisplay = document.getElementById('kills');
            const finalScoreSpan = document.getElementById('finalScore');
            const finalKillsSpan = document.getElementById('finalKills');
            const finalLevelSpan = document.getElementById('finalLevel');
            const radar = document.querySelector('.radar');
            const damageIndicator = document.getElementById('damageIndicator');
            const shieldSlot = document.getElementById('shieldSlot');
            const tripleShotSlot = document.getElementById('tripleShotSlot');
            const powerupIndicator = document.getElementById('powerupIndicator');
            const missionTimeDisplay = document.getElementById('missionTime');
            const accuracyDisplay = document.getElementById('accuracy');
            const medalDisplay = document.getElementById('medalDisplay');
            const weaponName = document.getElementById('weaponName');
            const weaponLevel = document.getElementById('weaponLevel');
            const weaponAmmo = document.getElementById('weaponAmmo');
            const bossHealth = document.getElementById('bossHealth');
            const bossHealthBar = document.getElementById('bossHealthBar');
            const bossHealthText = document.getElementById('bossHealthText');
            const notification = document.getElementById('notification');
            const levelIndicator = document.getElementById('levelIndicator');
            const bossKillsDisplay = document.getElementById('bossKills');
            const mapOptions = document.querySelectorAll('.map-option');
            
            // 游戏状态
            let gameRunning = false;
            let gamePaused = false;
            let score = 0;
            let health = 100;
            let kills = 0;
            let level = 1;
            let playerX = canvas.width / 2;
            let playerY = canvas.height - 100;
            let playerSpeed = 5;
            let missiles = [];
            let enemies = [];
            let explosions = [];
            let particles = [];
            let enemySpawnTimer = 0;
            let enemySpawnInterval = 100;
            let radarDots = [];
            let damageCooldown = 0;
            let items = [];
            let shieldActive = false;
            let tripleShotActive = false;
            let tripleShotTimer = 0;
            let shieldTimer = 0;
            let startTime = 0;
            let missilesFired = 0;
            let missilesHit = 0;
            let bossKills = 0;
            let currentMap = 'space';
            let boss = null;
            let bossActive = false;
            let bossSpawned = false;
            let currentWeapon = 1; // 1: 导弹, 2: 激光, 3: 炸弹
            let weaponLevels = [1, 1, 1]; // 三种武器的等级
            let weaponAmmoCount = [6, 50, 3]; // 三种武器的弹药量
            let maxWeaponAmmo = [6, 50, 3]; // 最大弹药量
            
            // 控制状态
            const keys = {
                ArrowLeft: false,
                ArrowRight: false,
                ArrowUp: false,
                ArrowDown: false,
                ' ': false,
                '1': false,
                '2': false,
                '3': false
            };
            
            // 地图背景
            const mapBackgrounds = {
                space: {
                    gradient: ['#0f2027', '#203a43', '#2c5364'],
                    stars: 250,
                    clouds: false,
                    ground: false
                },
                city: {
                    gradient: ['#2c3e50', '#4a6491'],
                    stars: 100,
                    clouds: true,
                    ground: true,
                    buildings: true
                },
                desert: {
                    gradient: ['#61443a', '#b98b73'],
                    stars: 50,
                    clouds: true,
                    ground: true,
                    sand: true
                },
                ocean: {
                    gradient: ['#1a2980', '#26d0ce'],
                    stars: 150,
                    clouds: true,
                    ground: false,
                    waves: true
                }
            };
            
            // 武器配置
            const weapons = [
                {
                    name: "AIM-120 AMRAAM",
                    color: "#ff9a3e",
                    speed: 10,
                    damage: 25,
                    cooldown: 15
                },
                {
                    name: "PLASMA LASER",
                    color: "#00ffcc",
                    speed: 15,
                    damage: 10,
                    cooldown: 3
                },
                {
                    name: "MK-84 BOMB",
                    color: "#ff5555",
                    speed: 8,
                    damage: 50,
                    cooldown: 60
                }
            ];
            
            // 玩家战机类
            class Player {
                constructor() {
                    this.width = 80;
                    this.height = 40;
                    this.x = playerX;
                    this.y = playerY;
                    this.speed = playerSpeed;
                    this.color = '#a0d0ff';
                    this.hitbox = {
                        x: this.x - this.width/2,
                        y: this.y - this.height/2,
                        width: this.width,
                        height: this.height
                    };
                }
                
                draw() {
                    // 绘制战机主体
                    ctx.fillStyle = this.color;
                    
                    // 机身
                    ctx.beginPath();
                    ctx.moveTo(this.x, this.y);
                    ctx.lineTo(this.x - this.width/2, this.y + this.height/2);
                    ctx.lineTo(this.x - this.width/3, this.y);
                    ctx.lineTo(this.x - this.width/2, this.y - this.height/2);
                    ctx.closePath();
                    ctx.fill();
                    
                    // 机翼
                    ctx.beginPath();
                    ctx.moveTo(this.x - this.width/4, this.y);
                    ctx.lineTo(this.x - this.width/2, this.y - this.height);
                    ctx.lineTo(this.x - this.width/1.5, this.y - this.height/3);
                    ctx.lineTo(this.x - this.width/1.5, this.y + this.height/3);
                    ctx.lineTo(this.x - this.width/2, this.y + this.height);
                    ctx.closePath();
                    ctx.fill();
                    
                    // 驾驶舱
                    ctx.fillStyle = '#4df0ff';
                    ctx.beginPath();
                    ctx.arc(this.x - this.width/8, this.y, this.height/4, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // 引擎火焰
                    const flameLength = 20;
                    ctx.fillStyle = '#ff9a3e';
                    ctx.beginPath();
                    ctx.moveTo(this.x - this.width/2, this.y - this.height/4);
                    ctx.lineTo(this.x - this.width/2 - flameLength, this.y);
                    ctx.lineTo(this.x - this.width/2, this.y + this.height/4);
                    ctx.closePath();
                    ctx.fill();
                    
                    // 火焰效果
                    ctx.fillStyle = '#ff3e3e';
                    ctx.beginPath();
                    ctx.moveTo(this.x - this.width/2 - flameLength/2, this.y - this.height/6);
                    ctx.lineTo(this.x - this.width/2 - flameLength, this.y);
                    ctx.lineTo(this.x - this.width/2 - flameLength/2, this.y + this.height/6);
                    ctx.closePath();
                    ctx.fill();
                    
                    // 更新碰撞箱位置
                    this.hitbox.x = this.x - this.width/2;
                    this.hitbox.y = this.y - this.height/2;
                    
                    // 绘制护盾
                    if (shieldActive) {
                        ctx.strokeStyle = 'rgba(0, 200, 255, 0.5)';
                        ctx.lineWidth = 3;
                        ctx.beginPath();
                        ctx.arc(
                            this.x,
                            this.y,
                            this.width * 0.8,
                            0,
                            Math.PI * 2
                        );
                        ctx.stroke();
                        
                        // 护盾光点
                        for (let i = 0; i < 12; i++) {
                            const angle = (i * Math.PI/6) + (Date.now()/200);
                            const px = this.x + Math.cos(angle) * this.width * 0.8;
                            const py = this.y + Math.sin(angle) * this.width * 0.8;
                            
                            ctx.fillStyle = '#4df0ff';
                            ctx.beginPath();
                            ctx.arc(px, py, 3, 0, Math.PI * 2);
                            ctx.fill();
                        }
                    }
                }
                
                update() {
                    if (keys.ArrowLeft && this.x > this.width/2) {
                        this.x -= this.speed;
                    }
                    if (keys.ArrowRight && this.x < canvas.width - this.width/2) {
                        this.x += this.speed;
                    }
                    if (keys.ArrowUp && this.y > this.height) {
                        this.y -= this.speed;
                    }
                    if (keys.ArrowDown && this.y < canvas.height - this.height/2) {
                        this.y += this.speed;
                    }
                }
            }
            
            // 导弹类
            class Missile {
                constructor(x, y, angle = 0, type = 0) {
                    this.x = x;
                    this.y = y;
                    this.width = 20;
                    this.height = 8;
                    this.speed = weapons[type].speed;
                    this.color = weapons[type].color;
                    this.angle = angle;
                    this.trail = [];
                    this.type = type;
                    this.hitbox = {
                        x: this.x - this.width,
                        y: this.y - this.height/2,
                        width: this.width,
                        height: this.height
                    };
                    this.damage = weapons[type].damage;
                }
                
                draw() {
                    ctx.save();
                    ctx.translate(this.x, this.y);
                    ctx.rotate(this.angle);
                    
                    // 激光武器特殊绘制
                    if (this.type === 1) {
                        ctx.strokeStyle = this.color;
                        ctx.lineWidth = 3;
                        ctx.beginPath();
                        ctx.moveTo(0, 0);
                        ctx.lineTo(-30, 0);
                        ctx.stroke();
                        
                        // 激光头
                        ctx.fillStyle = this.color;
                        ctx.beginPath();
                        ctx.arc(0, 0, 4, 0, Math.PI * 2);
                        ctx.fill();
                    } 
                    // 炸弹特殊绘制
                    else if (this.type === 2) {
                        ctx.fillStyle = this.color;
                        ctx.beginPath();
                        ctx.arc(0, 0, 10, 0, Math.PI * 2);
                        ctx.fill();
                        
                        ctx.fillStyle = '#333';
                        ctx.fillRect(-8, -5, 16, 10);
                    } 
                    // 普通导弹
                    else {
                        // 绘制尾迹
                        for (let i = 0; i < this.trail.length; i++) {
                            const point = this.trail[i];
                            const alpha = i / this.trail.length * 0.7;
                            ctx.fillStyle = `rgba(255, 100, 50, ${alpha})`;
                            ctx.beginPath();
                            ctx.arc(point.x - this.x, point.y - this.y, 2, 0, Math.PI * 2);
                            ctx.fill();
                        }
                        
                        // 导弹主体
                        ctx.fillStyle = this.color;
                        ctx.beginPath();
                        ctx.moveTo(0, 0);
                        ctx.lineTo(-this.width, -this.height/2);
                        ctx.lineTo(-this.width, this.height/2);
                        ctx.closePath();
                        ctx.fill();
                        
                        // 导弹尾焰
                        ctx.fillStyle = '#ff3e3e';
                        ctx.beginPath();
                        ctx.moveTo(-this.width, -this.height/4);
                        ctx.lineTo(-this.width - 15, 0);
                        ctx.lineTo(-this.width, this.height/4);
                        ctx.closePath();
                        ctx.fill();
                    }
                    
                    ctx.restore();
                    
                    // 更新碰撞箱位置
                    this.hitbox.x = this.x - this.width;
                    this.hitbox.y = this.y - this.height/2;
                }
                
                update() {
                    // 添加尾迹点（仅对导弹类型）
                    if (this.type === 0) {
                        this.trail.push({x: this.x, y: this.y});
                        if (this.trail.length > 10) {
                            this.trail.shift();
                        }
                    }
                    
                    this.x += this.speed * Math.cos(this.angle);
                    this.y += this.speed * Math.sin(this.angle);
                    return this.x > canvas.width || this.x < 0 || this.y > canvas.height || this.y < 0;
                }
            }
            
            // 敌机类
            class Enemy {
                constructor(type = 0) {
                    this.type = type;
                    
                    // 根据类型设置属性
                    switch(type) {
                        case 0: // 普通敌机
                            this.width = 60;
                            this.height = 30;
                            this.speed = 2 + Math.random() * 2;
                            this.color = '#ff7a7a';
                            this.health = 100;
                            this.scoreValue = 100;
                            break;
                        case 1: // 快速敌机
                            this.width = 50;
                            this.height = 25;
                            this.speed = 4 + Math.random() * 2;
                            this.color = '#7a7aff';
                            this.health = 70;
                            this.scoreValue = 150;
                            break;
                        case 2: // 重型敌机
                            this.width = 80;
                            this.height = 40;
                            this.speed = 1 + Math.random() * 1;
                            this.color = '#ffaa7a';
                            this.health = 200;
                            this.scoreValue = 200;
                            break;
                    }
                    
                    this.x = canvas.width + this.width;
                    this.y = Math.random() * (canvas.height - 200) + 100;
                    this.hitbox = {
                        x: this.x,
                        y: this.y - this.height/2,
                        width: this.width,
                        height: this.height
                    };
                    this.flameTimer = 0;
                }
                
                draw() {
                    ctx.fillStyle = this.color;
                    
                    // 敌机机身
                    ctx.beginPath();
                    ctx.moveTo(this.x, this.y);
                    ctx.lineTo(this.x + this.width/2, this.y + this.height/2);
                    ctx.lineTo(this.x + this.width/3, this.y);
                    ctx.lineTo(this.x + this.width/2, this.y - this.height/2);
                    ctx.closePath();
                    ctx.fill();
                    
                    // 机翼
                    ctx.beginPath();
                    ctx.moveTo(this.x + this.width/4, this.y);
                    ctx.lineTo(this.x + this.width/2, this.y - this.height);
                    ctx.lineTo(this.x + this.width/1.5, this.y - this.height/3);
                    ctx.lineTo(this.x + this.width/1.5, this.y + this.height/3);
                    ctx.lineTo(this.x + this.width/2, this.y + this.height);
                    ctx.closePath();
                    ctx.fill();
                    
                    // 驾驶舱
                    ctx.fillStyle = this.type === 1 ? '#7a7aff' : '#ff3e3e';
                    ctx.beginPath();
                    ctx.arc(this.x + this.width/8, this.y, this.height/4, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // 引擎火焰
                    this.flameTimer += 0.1;
                    const flameSize = 15 + Math.sin(this.flameTimer) * 5;
                    ctx.fillStyle = '#ff9a3e';
                    ctx.beginPath();
                    ctx.moveTo(this.x - 10, this.y);
                    ctx.lineTo(this.x - 10 - flameSize, this.y - 5);
                    ctx.lineTo(this.x - 10 - flameSize, this.y + 5);
                    ctx.closePath();
                    ctx.fill();
                    
                    // 血条
                    ctx.fillStyle = 'red';
                    ctx.fillRect(this.x - 20, this.y - 40, 40, 5);
                    ctx.fillStyle = 'lime';
                    ctx.fillRect(this.x - 20, this.y - 40, 40 * (this.health / 100), 5);
                    
                    // 更新碰撞箱位置
                    this.hitbox.x = this.x;
                    this.hitbox.y = this.y - this.height/2;
                }
                
                update() {
                    this.x -= this.speed;
                    return this.x < -this.width;
                }
                
                hit(damage) {
                    this.health -= damage;
                    return this.health <= 0;
                }
            }
            
            // Boss类
            class Boss {
                constructor() {
                    this.width = 200;
                    this.height = 80;
                    this.x = canvas.width + this.width;
                    this.y = canvas.height / 2;
                    this.speed = 1;
                    this.color = '#ff3e3e';
                    this.health = 1000;
                    this.maxHealth = 1000;
                    this.hitbox = {
                        x: this.x,
                        y: this.y - this.height/2,
                        width: this.width,
                        height: this.height
                    };
                    this.flameTimer = 0;
                    this.shootTimer = 0;
                    this.missiles = [];
                }
                
                draw() {
                    ctx.fillStyle = this.color;
                    
                    // Boss机身
                    ctx.beginPath();
                    ctx.moveTo(this.x, this.y);
                    ctx.lineTo(this.x + this.width, this.y + this.height/2);
                    ctx.lineTo(this.x + this.width/1.5, this.y);
                    ctx.lineTo(this.x + this.width, this.y - this.height/2);
                    ctx.closePath();
                    ctx.fill();
                    
                    // 机翼
                    ctx.beginPath();
                    ctx.moveTo(this.x + this.width/3, this.y);
                    ctx.lineTo(this.x + this.width/2, this.y - this.height * 1.5);
                    ctx.lineTo(this.x + this.width/1.2, this.y - this.height/2);
                    ctx.lineTo(this.x + this.width/1.2, this.y + this.height/2);
                    ctx.lineTo(this.x + this.width/2, this.y + this.height * 1.5);
                    ctx.closePath();
                    ctx.fill();
                    
                    // 驾驶舱
                    ctx.fillStyle = '#ff7a7a';
                    ctx.beginPath();
                    ctx.arc(this.x + this.width/4, this.y, this.height/3, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // 引擎火焰
                    this.flameTimer += 0.1;
                    const flameSize = 30 + Math.sin(this.flameTimer) * 10;
                    ctx.fillStyle = '#ff9a3e';
                    ctx.beginPath();
                    ctx.moveTo(this.x - 30, this.y - 15);
                    ctx.lineTo(this.x - 30 - flameSize, this.y - 20);
                    ctx.lineTo(this.x - 30 - flameSize, this.y + 20);
                    ctx.lineTo(this.x - 30, this.y + 15);
                    ctx.closePath();
                    ctx.fill();
                    
                    // 更新碰撞箱位置
                    this.hitbox.x = this.x;
                    this.hitbox.y = this.y - this.height/2;
                }
                
                update() {
                    this.x -= this.speed;
                    
                    // 保持在屏幕中间区域
                    if (this.y < canvas.height/3) {
                        this.y += 0.5;
                    } else if (this.y > canvas.height*2/3) {
                        this.y -= 0.5;
                    }
                    
                    // 发射导弹
                    this.shootTimer++;
                    if (this.shootTimer > 60 && this.x < canvas.width * 0.8) {
                        this.missiles.push(new Missile(this.x, this.y + 20, Math.PI, 0));
                        this.missiles.push(new Missile(this.x, this.y - 20, Math.PI, 0));
                        this.shootTimer = 0;
                        
                        // 发射效果
                        for (let i = 0; i < 10; i++) {
                            explosions.push(new Explosion(
                                this.x,
                                this.y + Math.random() * 40 - 20,
                                15
                            ));
                        }
                    }
                    
                    // 更新Boss导弹
                    for (let i = this.missiles.length - 1; i >= 0; i--) {
                        if (this.missiles[i].update()) {
                            this.missiles.splice(i, 1);
                        } else {
                            this.missiles[i].draw();
                        }
                    }
                    
                    return this.x < -this.width;
                }
                
                hit(damage) {
                    this.health -= damage;
                    
                    // 更新Boss血条
                    const healthPercent = Math.max(0, (this.health / this.maxHealth) * 100);
                    bossHealthBar.style.width = `${healthPercent}%`;
                    bossHealthText.textContent = `${Math.round(healthPercent)}%`;
                    
                    // 受伤效果
                    if (damage > 0) {
                        explosions.push(new Explosion(
                            this.x + Math.random() * this.width - this.width/2,
                            this.y + Math.random() * this.height - this.height/2,
                            20
                        ));
                    }
                    
                    return this.health <= 0;
                }
            }
            
            // 装备类
            class Item {
                constructor(x, y, type) {
                    this.x = x;
                    this.y = y;
                    this.width = 30;
                    this.height = 30;
                    this.speed = 2;
                    this.type = type; // 'shield' or 'triple'
                    this.color = type === 'shield' ? '#3498db' : '#f1c40f';
                    this.hitbox = {
                        x: this.x - this.width/2,
                        y: this.y - this.height/2,
                        width: this.width,
                        height: this.height
                    };
                    this.pulseTimer = 0;
                }
                
                draw() {
                    this.pulseTimer += 0.05;
                    const pulseSize = Math.sin(this.pulseTimer) * 5;
                    
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.width/2 + pulseSize, 0, Math.PI * 2);
                    ctx.fill();
                    
                    ctx.fillStyle = '#fff';
                    ctx.font = '20px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    
                    if (this.type === 'shield') {
                        ctx.fillText('🛡️', this.x, this.y);
                    } else {
                        ctx.fillText('🔺', this.x, this.y);
                    }
                }
                
                update() {
                    this.y += this.speed;
                    this.hitbox.y = this.y - this.height/2;
                    return this.y > canvas.height;
                }
            }
            
            // 爆炸效果类
            class Explosion {
                constructor(x, y, size = 40) {
                    this.x = x;
                    this.y = y;
                    this.radius = 5;
                    this.maxRadius = size;
                    this.growthRate = 2;
                    this.alpha = 1;
                    this.color = '#ff9a3e';
                    this.particles = [];
                    
                    // 创建爆炸粒子
                    for (let i = 0; i < 30; i++) {
                        this.particles.push({
                            x: this.x,
                            y: this.y,
                            size: Math.random() * 3 + 1,
                            speedX: Math.random() * 6 - 3,
                            speedY: Math.random() * 6 - 3,
                            color: ['#ff9a3e', '#ff3e3e', '#ffffff'][Math.floor(Math.random() * 3)],
                            alpha: 1
                        });
                    }
                }
                
                draw() {
                    // 主爆炸
                    ctx.globalAlpha = this.alpha;
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                    ctx.fill();
                    
                    // 爆炸粒子
                    for (let i = 0; i < this.particles.length; i++) {
                        const p = this.particles[i];
                        ctx.globalAlpha = p.alpha;
                        ctx.fillStyle = p.color;
                        ctx.beginPath();
                        ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                        ctx.fill();
                    }
                    
                    ctx.globalAlpha = 1;
                }
                
                update() {
                    this.radius += this.growthRate;
                    this.alpha -= 0.02;
                    
                    // 更新粒子
                    for (let i = this.particles.length - 1; i >= 0; i--) {
                        const p = this.particles[i];
                        p.x += p.speedX;
                        p.y += p.speedY;
                        p.alpha -= 0.02;
                        
                        if (p.alpha <= 0) {
                            this.particles.splice(i, 1);
                        }
                    }
                    
                    return this.radius > this.maxRadius || this.alpha <= 0;
                }
            }
            
            // 创建玩家战机
            let player = new Player();
            
            // 绘制游戏背景
            function drawBackground() {
                const map = mapBackgrounds[currentMap];
                
                // 绘制渐变背景
                const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                map.gradient.forEach((color, index) => {
                    gradient.addColorStop(index / (map.gradient.length - 1), color);
                });
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // 绘制星空
                ctx.fillStyle = '#ffffff';
                for (let i = 0; i < map.stars; i++) {
                    const x = Math.random() * canvas.width;
                    const y = Math.random() * canvas.height;
                    const radius = Math.random() * 1.5;
                    const alpha = Math.random() * 0.8 + 0.2;
                    ctx.globalAlpha = alpha;
                    ctx.beginPath();
                    ctx.arc(x, y, radius, 0, Math.PI * 2);
                    ctx.fill();
                }
                ctx.globalAlpha = 1;
                
                // 绘制云层
                if (map.clouds) {
                    ctx.fillStyle = 'rgba(200, 220, 255, 0.3)';
                    for (let i = 0; i < 5; i++) {
                        const x = Math.random() * canvas.width;
                        const y = Math.random() * canvas.height * 0.7;
                        const width = 100 + Math.random() * 100;
                        const height = 30 + Math.random() * 20;
                        ctx.beginPath();
                        ctx.ellipse(x, y, width, height, 0, 0, Math.PI * 2);
                        ctx.fill();
                    }
                }
                
                // 绘制地面（从下向上）
                if (map.ground) {
                    if (currentMap === 'city') {
                        // 城市建筑
                        ctx.fillStyle = '#333344';
                        for (let i = 0; i < 20; i++) {
                            const x = i * 45;
                            const height = 40 + Math.random() * 60;
                            ctx.fillRect(x, canvas.height - 20, 30, -height);
                            
                            // 窗户
                            ctx.fillStyle = '#ffcc00';
                            for (let j = 0; j < 4; j++) {
                                for (let k = 0; k < Math.floor(height / 15); k++) {
                                    ctx.fillRect(x + 5 + j*6, canvas.height - 25 - k*15, 4, 8);
                                }
                            }
                            ctx.fillStyle = '#333344';
                        }
                    } else if (currentMap === 'desert') {
                        // 沙漠
                        ctx.fillStyle = '#8B4513';
                        ctx.fillRect(0, canvas.height - 20, canvas.width, 20);
                        
                        ctx.fillStyle = '#A0522D';
                        ctx.fillRect(0, canvas.height - 40, canvas.width, 20);
                        
                        // 沙丘
                        ctx.fillStyle = '#CD853F';
                        ctx.beginPath();
                        ctx.moveTo(0, canvas.height - 20);
                        for (let i = 0; i < 10; i++) {
                            ctx.lineTo(i * 100, canvas.height - 40 - Math.sin(i) * 20);
                        }
                        ctx.lineTo(canvas.width, canvas.height - 20);
                        ctx.closePath();
                        ctx.fill();
                    }
                }
            }
            
            // 更新雷达显示
            function updateRadar() {
                // 清除旧雷达点
                document.querySelectorAll('.radar-dot').forEach(dot => dot.remove());
                radarDots = [];
                
                // 添加新雷达点
                enemies.forEach(enemy => {
                    // 计算敌机在雷达上的位置
                    const radarX = 100 + (enemy.x - canvas.width/2) / 10;
                    const radarY = 100 - (enemy.y - canvas.height/2) / 10;
                    
                    if (radarX > 0 && radarX < 200 && radarY > 0 && radarY < 200) {
                        const dot = document.createElement('div');
                        dot.className = 'radar-dot';
                        dot.style.left = `${radarX}px`;
                        dot.style.top = `${radarY}px`;
                        
                        // 根据敌机类型设置颜色
                        if (enemy.type === 1) {
                            dot.style.background = '#7a7aff';
                            dot.style.boxShadow = '0 0 8px #7a7aff';
                        } else if (enemy.type === 2) {
                            dot.style.background = '#ffaa7a';
                            dot.style.boxShadow = '0 0 8px #ffaa7a';
                        }
                        
                        radar.appendChild(dot);
                        radarDots.push({x: radarX, y: radarY});
                    }
                });
                
                // 添加Boss雷达点
                if (boss) {
                    const radarX = 100 + (boss.x - canvas.width/2) / 10;
                    const radarY = 100 - (boss.y - canvas.height/2) / 10;
                    
                    if (radarX > 0 && radarX < 200 && radarY > 0 && radarY < 200) {
                        const dot = document.createElement('div');
                        dot.className = 'radar-dot';
                        dot.style.background = '#ff3e3e';
                        dot.style.boxShadow = '0 0 12px #ff3e3e';
                        dot.style.width = '12px';
                        dot.style.height = '12px';
                        dot.style.left = `${radarX}px`;
                        dot.style.top = `${radarY}px`;
                        radar.appendChild(dot);
                    }
                }
                
                // 添加装备雷达点
                items.forEach(item => {
                    const radarX = 100 + (item.x - canvas.width/2) / 10;
                    const radarY = 100 - (item.y - canvas.height/2) / 10;
                    
                    if (radarX > 0 && radarX < 200 && radarY > 0 && radarY < 200) {
                        const dot = document.createElement('div');
                        dot.className = 'radar-dot';
                        dot.style.background = item.type === 'shield' ? '#3498db' : '#f1c40f';
                        dot.style.boxShadow = `0 0 8px ${item.type === 'shield' ? '#3498db' : '#f1c40f'}`;
                        dot.style.left = `${radarX}px`;
                        dot.style.top = `${radarY}px`;
                        radar.appendChild(dot);
                    }
                });
            }
            
            // 生成敌机
            function spawnEnemy() {
                if (enemySpawnTimer >= enemySpawnInterval) {
                    let type = 0;
                    
                    // 根据关卡增加敌机类型
                    if (level > 2 && Math.random() < 0.3) {
                        type = 1; // 快速敌机
                    }
                    if (level > 4 && Math.random() < 0.2) {
                        type = 2; // 重型敌机
                    }
                    
                    enemies.push(new Enemy(type));
                    enemySpawnTimer = 0;
                    enemySpawnInterval = Math.max(20, 100 - level * 5);
                }
                enemySpawnTimer++;
            }
            
            // 生成Boss
            function spawnBoss() {
                if (!bossSpawned && level % 5 === 0) {
                    boss = new Boss();
                    bossActive = true;
                    bossSpawned = true;
                    bossHealth.classList.remove('hidden');
                    
                    // 显示通知
                    showNotification("⚠️ 警告! 大型敌机接近 ⚠️");
                }
            }
            
            // 生成装备
            function spawnItem(x, y) {
                if (Math.random() < 0.3) { // 30%几率掉落装备
                    const type = Math.random() < 0.5 ? 'shield' : 'triple';
                    items.push(new Item(x, y, type));
                }
            }
            
            // 发射导弹
            function fireMissile() {
                if (weaponAmmoCount[currentWeapon] <= 0) {
                    // 弹药不足
                    showNotification("弹药不足!");
                    return;
                }
                
                missilesFired++;
                weaponAmmoCount[currentWeapon]--;
                updateWeaponDisplay();
                
                if (currentWeapon === 0) {
                    // 导弹武器
                    if (tripleShotActive) {
                        // 三连发模式
                        missiles.push(new Missile(player.x, player.y, -0.1, currentWeapon));
                        missiles.push(new Missile(player.x, player.y, 0, currentWeapon));
                        missiles.push(new Missile(player.x, player.y, 0.1, currentWeapon));
                    } else {
                        // 普通模式
                        missiles.push(new Missile(player.x, player.y, 0, currentWeapon));
                    }
                } else if (currentWeapon === 1) {
                    // 激光武器
                    missiles.push(new Missile(player.x, player.y, 0, currentWeapon));
                } else if (currentWeapon === 2) {
                    // 炸弹武器
                    missiles.push(new Missile(player.x, player.y, 0.2, currentWeapon));
                    missiles.push(new Missile(player.x, player.y, -0.2, currentWeapon));
                }
                
                // 发射效果
                for (let i = 0; i < 5; i++) {
                    explosions.push(new Explosion(
                        player.x - 40,
                        player.y + Math.random() * 20 - 10,
                        10
                    ));
                }
            }
            
            // 激活装备
            function activatePowerup(type) {
                if (type === 'shield') {
                    shieldActive = true;
                    shieldTimer = 600; // 10秒
                    shieldSlot.classList.add('active');
                    powerupIndicator.textContent = '护盾已激活!';
                    powerupIndicator.style.display = 'block';
                    
                    // 护盾激活特效
                    for (let i = 0; i < 20; i++) {
                        explosions.push(new Explosion(
                            player.x + Math.random() * 60 - 30,
                            player.y + Math.random() * 60 - 30,
                            15
                        ));
                    }
                    
                    setTimeout(() => {
                        powerupIndicator.style.display = 'none';
                    }, 2000);
                } else if (type === 'triple') {
                    tripleShotActive = true;
                    tripleShotTimer = 450; // 7.5秒
                    tripleShotSlot.classList.add('active');
                    powerupIndicator.textContent = '三连发已激活!';
                    powerupIndicator.style.display = 'block';
                    
                    setTimeout(() => {
                        powerupIndicator.style.display = 'none';
                    }, 2000);
                }
            }
            
            // 显示通知
            function showNotification(text) {
                notification.textContent = text;
                notification.style.display = 'block';
                
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 3000);
            }
            
            // 显示关卡指示
            function showLevelIndicator() {
                levelIndicator.textContent = `作战区域 ${level}`;
                levelIndicator.style.display = 'block';
                
                setTimeout(() => {
                    levelIndicator.style.display = 'none';
                }, 2000);
            }
            
            // 更新武器显示
            function updateWeaponDisplay() {
                const weapon = weapons[currentWeapon];
                weaponName.textContent = weapon.name;
                weaponLevel.textContent = `Lv.${weaponLevels[currentWeapon]}`;
                
                // 更新弹药显示
                weaponAmmo.innerHTML = '';
                const maxAmmo = maxWeaponAmmo[currentWeapon];
                
                for (let i = 0; i < maxAmmo; i++) {
                    const dot = document.createElement('div');
                    dot.className = 'ammo-dot';
                    if (i < weaponAmmoCount[currentWeapon]) {
                        dot.style.background = weapon.color;
                        dot.style.boxShadow = `0 0 5px ${weapon.color}`;
                    } else {
                        dot.style.background = '#555';
                    }
                    weaponAmmo.appendChild(dot);
                }
            }
            
            // 升级武器
            function upgradeWeapon(weaponIndex) {
                if (score < 500) {
                    showNotification("积分不足! 需要500分");
                    return;
                }
                
                weaponLevels[weaponIndex]++;
                score -= 500;
                
                // 根据武器类型升级
                switch(weaponIndex) {
                    case 0: // 导弹
                        weapons[0].damage += 5;
                        maxWeaponAmmo[0]++;
                        weaponAmmoCount[0] = maxWeaponAmmo[0];
                        break;
                    case 1: // 激光
                        weapons[1].damage += 2;
                        maxWeaponAmmo[1] += 10;
                        weaponAmmoCount[1] = maxWeaponAmmo[1];
                        break;
                    case 2: // 炸弹
                        weapons[2].damage += 10;
                        maxWeaponAmmo[2]++;
                        weaponAmmoCount[2] = maxWeaponAmmo[2];
                        break;
                }
                
                showNotification(`武器升级! ${weapons[weaponIndex].name} Lv.${weaponLevels[weaponIndex]}`);
                updateWeaponDisplay();
            }
            
            // 切换武器
            function switchWeapon(weaponIndex) {
                currentWeapon = weaponIndex;
                updateWeaponDisplay();
                showNotification(`已切换: ${weapons[weaponIndex].name}`);
            }
            
            // 检测碰撞
            function checkCollisions() {
                // 导弹与敌机碰撞
                for (let i = missiles.length - 1; i >= 0; i--) {
                    // 先检查与Boss的碰撞
                    if (boss) {
                        const missile = missiles[i];
                        
                        // 碰撞检测
                        if (
                            missile.hitbox.x < boss.hitbox.x + boss.hitbox.width &&
                            missile.hitbox.x + missile.hitbox.width > boss.hitbox.x &&
                            missile.hitbox.y < boss.hitbox.y + boss.hitbox.height &&
                            missile.hitbox.y + missile.hitbox.height > boss.hitbox.y
                        ) {
                            missilesHit++;
                            
                            if (boss.hit(missile.damage)) {
                                // Boss被摧毁
                                explosions.push(new Explosion(boss.x, boss.y, 120));
                                boss = null;
                                bossActive = false;
                                score += 2000;
                                kills++;
                                bossKills++;
                                killsDisplay.textContent = kills;
                                bossHealth.classList.add('hidden');
                                
                                // 生成装备
                                spawnItem(boss.x, boss.y);
                                
                                // 显示通知
                                showNotification("🎉 Boss击破! +2000分 🎉");
                            }
                            missiles.splice(i, 1);
                            continue;
                        }
                    }
                    
                    // 检查与普通敌机的碰撞
                    for (let j = enemies.length - 1; j >= 0; j--) {
                        const missile = missiles[i];
                        const enemy = enemies[j];
                        
                        // 碰撞检测
                        if (
                            missile.hitbox.x < enemy.hitbox.x + enemy.hitbox.width &&
                            missile.hitbox.x + missile.hitbox.width > enemy.hitbox.x &&
                            missile.hitbox.y < enemy.hitbox.y + enemy.hitbox.height &&
                            missile.hitbox.y + missile.hitbox.height > enemy.hitbox.y
                        ) {
                            missilesHit++;
                            
                            if (enemy.hit(missile.damage)) {
                                // 敌机被摧毁
                                explosions.push(new Explosion(enemy.x, enemy.y, 60));
                                enemies.splice(j, 1);
                                score += enemy.scoreValue;
                                kills++;
                                killsDisplay.textContent = kills;
                                
                                // 生成装备
                                spawnItem(enemy.x, enemy.y);
                                
                                // 每击落5架敌机升一级
                                if (kills % 5 === 0) {
                                    level++;
                                    levelDisplay.textContent = level;
                                    showLevelIndicator();
                                }
                                
                                // 每1000分获得一次升级机会
                                if (score % 1000 === 0) {
                                    showNotification("获得升级机会! 按1-3升级武器");
                                }
                            }
                            missiles.splice(i, 1);
                            break;
                        }
                    }
                }
                
                // 玩家与敌机碰撞
                for (let i = enemies.length - 1; i >= 0; i--) {
                    const enemy = enemies[i];
                    
                    // 碰撞检测
                    if (
                        player.hitbox.x < enemy.hitbox.x + enemy.hitbox.width &&
                        player.hitbox.x + player.hitbox.width > enemy.hitbox.x &&
                        player.hitbox.y < enemy.hitbox.y + enemy.hitbox.height &&
                        player.hitbox.y + player.hitbox.height > enemy.hitbox.y
                    ) {
                        // 护盾保护
                        if (shieldActive) {
                            // 移除敌机
                            explosions.push(new Explosion(enemy.x, enemy.y, 40));
                            enemies.splice(i, 1);
                            continue;
                        }
                        
                        // 只在冷却时间结束后造成伤害
                        if (damageCooldown <= 0) {
                            health -= 20;
                            healthDisplay.textContent = `${health}%`;
                            damageCooldown = 60; // 1秒冷却时间
                            
                            // 显示伤害指示器
                            damageIndicator.style.opacity = 1;
                            setTimeout(() => {
                                damageIndicator.style.opacity = 0;
                            }, 300);
                            
                            // 创建爆炸效果
                            explosions.push(new Explosion(player.x, player.y, 30));
                            
                            // 移除敌机
                            explosions.push(new Explosion(enemy.x, enemy.y, 50));
                            enemies.splice(i, 1);
                            
                            // 检查游戏是否结束
                            if (health <= 0) {
                                health = 0;
                                healthDisplay.textContent = `${health}%`;
                                gameOver();
                            }
                        }
                    }
                }
                
                // 玩家与Boss导弹碰撞
                if (boss) {
                    for (let i = boss.missiles.length - 1; i >= 0; i--) {
                        const missile = boss.missiles[i];
                        
                        // 碰撞检测
                        if (
                            player.hitbox.x < missile.hitbox.x + missile.hitbox.width &&
                            player.hitbox.x + player.hitbox.width > missile.hitbox.x &&
                            player.hitbox.y < missile.hitbox.y + missile.hitbox.height &&
                            player.hitbox.y + player.hitbox.height > missile.hitbox.y
                        ) {
                            // 护盾保护
                            if (shieldActive) {
                                boss.missiles.splice(i, 1);
                                explosions.push(new Explosion(missile.x, missile.y, 30));
                                continue;
                            }
                            
                            if (damageCooldown <= 0) {
                                health -= 15;
                                healthDisplay.textContent = `${health}%`;
                                damageCooldown = 60;
                                
                                damageIndicator.style.opacity = 1;
                                setTimeout(() => {
                                    damageIndicator.style.opacity = 0;
                                }, 300);
                                
                                explosions.push(new Explosion(missile.x, missile.y, 40));
                                boss.missiles.splice(i, 1);
                                
                                if (health <= 0) {
                                    health = 0;
                                    healthDisplay.textContent = `${health}%`;
                                    gameOver();
                                }
                            }
                        }
                    }
                }
                
                // 玩家与装备碰撞
                for (let i = items.length - 1; i >= 0; i--) {
                    const item = items[i];
                    
                    // 碰撞检测
                    if (
                        player.hitbox.x < item.hitbox.x + item.hitbox.width &&
                        player.hitbox.x + player.hitbox.width > item.hitbox.x &&
                        player.hitbox.y < item.hitbox.y + item.hitbox.height &&
                        player.hitbox.y + player.hitbox.height > item.hitbox.y
                    ) {
                        activatePowerup(item.type);
                        items.splice(i, 1);
                    }
                }
            }
            
            // 更新装备计时器
            function updatePowerups() {
                if (shieldActive) {
                    shieldTimer--;
                    if (shieldTimer <= 0) {
                        shieldActive = false;
                        shieldSlot.classList.remove('active');
                    }
                }
                
                if (tripleShotActive) {
                    tripleShotTimer--;
                    if (tripleShotTimer <= 0) {
                        tripleShotActive = false;
                        tripleShotSlot.classList.remove('active');
                    }
                }
            }
            
            // 补给弹药
            function resupplyAmmo() {
                // 每5秒补充1发导弹
                if (Date.now() % 5000 < 16) {
                    if (weaponAmmoCount[0] < maxWeaponAmmo[0]) {
                        weaponAmmoCount[0]++;
                        updateWeaponDisplay();
                    }
                }
                
                // 每2秒补充5发激光
                if (Date.now() % 2000 < 16) {
                    if (weaponAmmoCount[1] < maxWeaponAmmo[1]) {
                        weaponAmmoCount[1] = Math.min(weaponAmmoCount[1] + 5, maxWeaponAmmo[1]);
                        updateWeaponDisplay();
                    }
                }
                
                // 每10秒补充1发炸弹
                if (Date.now() % 10000 < 16) {
                    if (weaponAmmoCount[2] < maxWeaponAmmo[2]) {
                        weaponAmmoCount[2]++;
                        updateWeaponDisplay();
                    }
                }
            }
            
            // 游戏结束
            function gameOver() {
                gameRunning = false;
                finalScoreSpan.textContent = score;
                finalKillsSpan.textContent = kills;
                finalLevelSpan.textContent = level;
                bossKillsDisplay.textContent = bossKills;
                
                // 计算任务时间
                const missionTime = (Date.now() - startTime) / 1000;
                const minutes = Math.floor(missionTime / 60);
                const seconds = Math.floor(missionTime % 60);
                missionTimeDisplay.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                
                // 计算命中率
                const accuracy = missilesFired > 0 ? Math.round((missilesHit / missilesFired) * 100) : 0;
                accuracyDisplay.textContent = `${accuracy}%`;
                
                // 根据分数显示勋章
                if (score > 10000) {
                    medalDisplay.textContent = "🏆";
                } else if (score > 7000) {
                    medalDisplay.textContent = "🏅";
                } else if (score > 4000) {
                    medalDisplay.textContent = "🥇";
                } else if (score > 2000) {
                    medalDisplay.textContent = "🥈";
                } else {
                    medalDisplay.textContent = "🥉";
                }
                
                gameOverScreen.classList.remove('hidden');
            }
            
            // 重置游戏
            function resetGame() {
                gameRunning = true;
                gamePaused = false;
                score = 0;
                health = 100;
                kills = 0;
                level = 1;
                missiles = [];
                enemies = [];
                items = [];
                explosions = [];
                particles = [];
                enemySpawnTimer = 0;
                player = new Player();
                scoreDisplay.textContent = score;
                healthDisplay.textContent = `${health}%`;
                killsDisplay.textContent = kills;
                levelDisplay.textContent = level;
                gameOverScreen.classList.add('hidden');
                pauseMenu.style.display = 'none';
                damageCooldown = 0;
                damageIndicator.style.opacity = 0;
                boss = null;
                bossActive = false;
                bossSpawned = false;
                bossHealth.classList.add('hidden');
                bossKills = 0;
                
                // 重置装备状态
                shieldActive = false;
                tripleShotActive = false;
                shieldSlot.classList.remove('active');
                tripleShotSlot.classList.remove('active');
                powerupIndicator.style.display = 'none';
                
                // 重置武器状态
                weaponLevels = [1, 1, 1];
                weaponAmmoCount = [6, 50, 3];
                maxWeaponAmmo = [6, 50, 3];
                currentWeapon = 0;
                updateWeaponDisplay();
                
                // 重置统计
                startTime = Date.now();
                missilesFired = 0;
                missilesHit = 0;
                
                // 显示关卡
                showLevelIndicator();
            }
            
            // 返回主菜单
            function returnToMenu() {
                resetGame();
                startScreen.classList.remove('hidden');
                gameOverScreen.classList.add('hidden');
                pauseMenu.style.display = 'none';
            }
            
            // 暂停游戏
            function togglePause() {
                gamePaused = !gamePaused;
                if (gamePaused) {
                    pauseMenu.style.display = 'block';
                    showNotification("游戏暂停");
                } else {
                    pauseMenu.style.display = 'none';
                    showNotification("游戏继续");
                }
            }
            
            // 游戏主循环
            function gameLoop() {
                if (!gameRunning || gamePaused) return;
                
                // 清空画布
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // 绘制背景
                drawBackground();
                
                // 更新玩家
                player.update();
                player.draw();
                
                // 生成敌机
                spawnEnemy();
                
                // 生成Boss
                spawnBoss();
                
                // 更新导弹
                for (let i = missiles.length - 1; i >= 0; i--) {
                    if (missiles[i].update()) {
                        missiles.splice(i, 1);
                    } else {
                        missiles[i].draw();
                    }
                }
                
                // 更新敌机
                for (let i = enemies.length - 1; i >= 0; i--) {
                    if (enemies[i].update()) {
                        enemies.splice(i, 1);
                    } else {
                        enemies[i].draw();
                    }
                }
                
                // 更新Boss
                if (boss) {
                    if (boss.update()) {
                        boss = null;
                        bossActive = false;
                        bossHealth.classList.add('hidden');
                    } else {
                        boss.draw();
                    }
                }
                
                // 更新装备
                for (let i = items.length - 1; i >= 0; i--) {
                    if (items[i].update()) {
                        items.splice(i, 1);
                    } else {
                        items[i].draw();
                    }
                }
                
                // 更新爆炸效果
                for (let i = explosions.length - 1; i >= 0; i--) {
                    if (explosions[i].update()) {
                        explosions.splice(i, 1);
                    } else {
                        explosions[i].draw();
                    }
                }
                
                // 检测碰撞
                checkCollisions();
                
                // 更新装备状态
                updatePowerups();
                
                // 更新雷达
                updateRadar();
                
                // 更新UI
                scoreDisplay.textContent = score;
                
                // 更新伤害冷却时间
                if (damageCooldown > 0) {
                    damageCooldown--;
                }
                
                // 补给弹药
                resupplyAmmo();
                
                requestAnimationFrame(gameLoop);
            }
            
            // 开始游戏
            function startGame() {
                startScreen.classList.add('hidden');
                resetGame();
                gameLoop();
            }
            
            // 事件监听
            startButton.addEventListener('click', startGame);
            restartButton.addEventListener('click', resetGame);
            topRestartButton.addEventListener('click', resetGame);
            pauseRestartButton.addEventListener('click', resetGame);
            menuButton.addEventListener('click', returnToMenu);
            menuButton2.addEventListener('click', returnToMenu);
            resumeButton.addEventListener('click', togglePause);
            
            // 地图选择
            mapOptions.forEach(option => {
                option.addEventListener('click', () => {
                    mapOptions.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                    currentMap = option.dataset.map;
                });
            });
            
            document.addEventListener('keydown', (e) => {
                if (e.key in keys) {
                    keys[e.key] = true;
                }
                
                if (e.key === ' ' && gameRunning && !gamePaused) {
                    fireMissile();
                }
                
                if (e.key === 'p' || e.key === 'Escape') {
                    if (gameRunning) {
                        togglePause();
                    }
                }
                
                if (e.key === 'r' && gameRunning) {
                    resetGame();
                }
                
                // 武器切换
                if (e.key === '1') {
                    if (gameRunning && !gamePaused) {
                        if (keys.Shift) {
                            upgradeWeapon(0);
                        } else {
                            switchWeapon(0);
                        }
                    }
                }
                if (e.key === '2') {
                    if (gameRunning && !gamePaused) {
                        if (keys.Shift) {
                            upgradeWeapon(1);
                        } else {
                            switchWeapon(1);
                        }
                    }
                }
                if (e.key === '3') {
                    if (gameRunning && !gamePaused) {
                        if (keys.Shift) {
                            upgradeWeapon(2);
                        } else {
                            switchWeapon(2);
                        }
                    }
                }
            });
            
            document.addEventListener('keyup', (e) => {
                if (e.key in keys) {
                    keys[e.key] = false;
                }
            });
        });
    </script>
</body>
</html>